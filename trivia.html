<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trivia - Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #0d1117;
      color: #c9d1d9;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #58a6ff;
    }
    .seccion {
      border: 1px solid #30363d;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
      background-color: #161b22;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, select, button {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 5px;
      border: none;
      background-color: #21262d;
      color: #c9d1d9;
    }
    button {
      background-color: #238636;
      cursor: pointer;
      margin-top: 15px;
    }
    button:hover {
      background-color: #2ea043;
    }
    .pregunta {
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid #30363d;
      border-radius: 5px;
      background-color: #0d1117;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #30363d;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #21262d;
    }
  </style>
</head>
<body>

  <h1>Administrar Trivia</h1>

  <div class="seccion">
    <h2>Agregar Pregunta</h2>
    <label for="nivel-pregunta">Nivel</label>
    <select id="nivel-pregunta">
      <option value="basico">Básico</option>
      <option value="medio">Medio</option>
      <option value="avanzado">Avanzado</option>
    </select>

    <label for="texto-pregunta">Texto de la pregunta</label>
    <input type="text" id="texto-pregunta" />

    <label for="op1">Opción 1</label>
    <input type="text" id="op1" />

    <label for="op2">Opción 2</label>
    <input type="text" id="op2" />

    <label for="op3">Opción 3</label>
    <input type="text" id="op3" />

    <label for="correcta">Número de opción correcta (1, 2 o 3)</label>
    <input type="number" id="correcta" min="1" max="3" />

    <button id="guardar-pregunta">Guardar Pregunta</button>

    <h3>Preguntas guardadas</h3>
    <ul id="lista-preguntas"></ul>
  </div>

  <div class="seccion">
    <h2>Precios por Nivel</h2>

    <label for="nivel-select">Nivel</label>
    <select id="nivel-select">
      <option value="basico">Básico</option>
      <option value="medio">Medio</option>
      <option value="avanzado">Avanzado</option>
    </select>

    <label for="nuevo-precio">Nuevo precio</label>
    <input type="number" id="nuevo-precio" />

    <button id="guardar-nivel">Guardar Precio</button>

    <h3>Precios actuales</h3>
    <ul id="lista-precios"></ul>
  </div>

  <div class="seccion">
    <h3>Ranking</h3>
    <table>
      <thead>
        <tr>
          <th>Usuario</th>
          <th>Puntaje</th>
        </tr>
      </thead>
      <tbody id="ranking-trivia"></tbody>
    </table>
  </div>

  <div class="seccion">
    <h3>Premios trivia</h3>
    <table>
      <thead>
        <tr>
          <th>Usuario</th>
          <th>Monto</th>
          <th>Moneda</th>
          <th>Fecha</th>
          <th>Aprobado</th>
        </tr>
      </thead>
      <tbody id="premios-trivia"></tbody>
    </table>
  </div>

  <!-- BLOQUE NUEVO AGREGADO -->
  <div class="seccion">
    <h2>Agregar Pregunta (Formulario alternativo)</h2>
    <form id="form-trivia">
      <select id="nivel">
        <option value="básico">Básico</option>
        <option value="medio">Medio</option>
        <option value="avanzado">Avanzado</option>
      </select>
      <input type="text" id="pregunta" placeholder="Texto de la pregunta">
      <input type="text" id="opcion1" placeholder="Opción 1">
      <input type="text" id="opcion2" placeholder="Opción 2">
      <input type="text" id="opcion3" placeholder="Opción 3">
      <input type="text" id="opcion4" placeholder="Opción 4">
      <input type="number" id="correcta" min="0" max="3" placeholder="Índice correcta (0-3)">
      <button type="button" onclick="guardarPregunta()">Guardar</button>
    </form>
  </div>
<script>
  // BLOQUE NUEVO DE SCRIPT AGREGADO
  const supabase = supabase.createClient(
    "https://ovulezkcxwrjvyxlxsdv.supabase.co",
    "SUPABASE_ANON_KEY"
  );

  async function guardarPregunta() {
    const nivel = document.getElementById('nivel').value.trim();
    const texto = document.getElementById('pregunta').value.trim();
    const correcta = parseInt(document.getElementById('correcta').value);

    const opciones = [
      document.getElementById('opcion1').value.trim(),
      document.getElementById('opcion2').value.trim(),
      document.getElementById('opcion3').value.trim(),
      document.getElementById('opcion4').value.trim()
    ];

    if (!nivel || !texto || opciones.some(op => !op) || isNaN(correcta)) {
      alert('Completa todos los campos correctamente.');
      return;
    }

    const { data, error } = await supabase.from('preguntas_trivia').insert([
      {
        nivel,
        texto,
        opciones,
        correcta
      }
    ]);

    if (error) {
      console.error('Error al guardar:', error);
      alert('Error al guardar la pregunta. Ver consola para más detalles.');
    } else {
      alert('Pregunta guardada con éxito ✅');
      document.getElementById('form-trivia').reset();
    }
  }
</script>

<script>
  // Instancia única de Supabase
  const supabaseUrl = "https://ovulezkcxwrjvyxlxsdv.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92dWxlemtjeHdyanZ5eGx4c2R2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNzY5OTksImV4cCI6MjA2NDY1Mjk5OX0.ac82tkUR7AT0QVsuzuAGA8SXLkgnM9OX62meYNGnToI";
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  // Guarda el rol para reutilizar
  let rolUsuario = null;

  async function obtenerRolUsuario() {
    try {
      const { data: authData, error: authError } = await supabase.auth.getUser();
      if (authError || !authData.user) {
        alert("No estás autenticado. Por favor inicia sesión.");
        throw new Error("No autenticado");
      }
      const userId = authData.user.id;

      const { data: perfilData, error: perfilError } = await supabase
        .from("profiles")
        .select("rol")
        .eq("id", userId)
        .single();

      if (perfilError || !perfilData) {
        alert("Error obteniendo perfil de usuario.");
        throw new Error("Error perfil");
      }

      rolUsuario = perfilData.rol;
      return rolUsuario;
    } catch (e) {
      console.error(e);
      return null;
    }
  }

  async function cargarPreguntas(nivel) {
    const { data, error } = await supabase
      .from("preguntas_trivia")
      .select("*")
      .eq("nivel", nivel);

    const lista = document.getElementById("lista-preguntas");
    lista.innerHTML = "";

    if (error) {
      lista.innerHTML = "Error cargando preguntas: " + error.message;
      return;
    }

    if (!data || data.length === 0) {
      lista.innerHTML = "<li>No hay preguntas para este nivel.</li>";
      return;
    }

    data.forEach(pregunta => {
      const li = document.createElement("li");
      li.textContent = `${pregunta.texto} (Opciones: ${pregunta.opciones.join(", ")}) [Correcta: ${pregunta.correcta + 1}]`;
      lista.appendChild(li);
    });
  }

  async function cargarPrecios() {
    const { data, error } = await supabase.from("niveles_trivia").select("*");
    const lista = document.getElementById("lista-precios");
    lista.innerHTML = "";
    if (error) {
      lista.innerHTML = `<li>Error al cargar precios: ${error.message}</li>`;
      return;
    }
    data.forEach(({ nivel, precio }) => {
      const li = document.createElement("li");
      li.textContent = `${nivel}: $${precio}`;
      lista.appendChild(li);
    });
  }

  async function cargarRanking() {
    const { data, error } = await supabase
      .from("ranking_trivia")
      .select("usuario_id, puntaje")
      .order("puntaje", { ascending: false });

    const tbody = document.getElementById("ranking-trivia");
    tbody.innerHTML = "";

    if (error) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="2">Error cargando ranking: ${error.message}</td>`;
      tbody.appendChild(tr);
      return;
    }

    if (!data || data.length === 0) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="2">No hay datos en ranking</td>`;
      tbody.appendChild(tr);
      return;
    }

    data.forEach(({ usuario_id, puntaje }) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${usuario_id}</td><td>${puntaje}</td>`;
      tbody.appendChild(tr);
    });
  }

  async function cargarPremios() {
    const { data, error } = await supabase
      .from("recompensas")
      .select("*")
      .eq("tipo", "trivia")
      .order("fecha", { ascending: false });

    const tbody = document.getElementById("premios-trivia");
    tbody.innerHTML = "";

    if (error) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="5">Error cargando premios: ${error.message}</td>`;
      tbody.appendChild(tr);
      return;
    }

    if (!data || data.length === 0) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="5">No hay premios registrados</td>`;
      tbody.appendChild(tr);
      return;
    }

    data.forEach(premio => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${premio.usuario_id}</td>
        <td>${premio.monto}</td>
        <td>${premio.moneda}</td>
        <td>${new Date(premio.fecha).toLocaleDateString()}</td>
        <td>${premio.aprobado ? "✅" : "❌"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  document.getElementById("guardar-nivel").addEventListener("click", async () => {
    const nivel = document.getElementById("nivel-select").value;
    const precio = parseInt(document.getElementById("nuevo-precio").value);
    if (!nivel || isNaN(precio)) {
      alert("Completa todos los campos para guardar el precio.");
      return;
    }
    const { error } = await supabase.from("niveles_trivia").upsert([{ nivel, precio }]);
    if (error) {
      alert("Error al guardar precio: " + error.message);
      return;
    }
    alert("Precio actualizado correctamente.");
    document.getElementById("nuevo-precio").value = "";
    cargarPrecios();
  });

  // Esta es la función corregida y usando la misma instancia supabase:
  async function guardarPregunta() {
    const nivel = document.getElementById('nivel').value.trim();
    const texto = document.getElementById('pregunta').value.trim();
    const correcta = parseInt(document.getElementById('correcta').value);

    const opciones = [
      document.getElementById('opcion1').value.trim(),
      document.getElementById('opcion2').value.trim(),
      document.getElementById('opcion3').value.trim(),
      document.getElementById('opcion4').value.trim()
    ];

    if (!nivel || !texto || opciones.some(op => !op) || isNaN(correcta)) {
      alert('Completa todos los campos correctamente.');
      return;
    }

    try {
      // Validar rol antes de insertar
      const rol = await obtenerRolUsuario();
      if (rol !== "admi") {
        alert("No tienes permisos para guardar preguntas.");
        return;
      }

      const { data, error } = await supabase.from('preguntas_trivia').insert([
        { nivel, texto, opciones, correcta }
      ]);
      if (error) {
        alert("Error al guardar la pregunta: " + error.message);
        return;
      }
      alert('Pregunta guardada con éxito ✅');
      document.getElementById('form-trivia').reset();
      cargarPreguntas(nivel);
    } catch(e) {
      alert("Error inesperado: " + e.message);
      console.error(e);
    }
  }

  document.getElementById("guardar-pregunta").addEventListener("click", async () => {
    const nivel = document.getElementById("nivel-pregunta").value;
    const texto = document.getElementById("texto-pregunta").value.trim();
    const op1 = document.getElementById("op1").value.trim();
    const op2 = document.getElementById("op2").value.trim();
    const op3 = document.getElementById("op3").value.trim();
    const correctaInput = parseInt(document.getElementById("correcta").value);

    // Ajustamos correcta para que sea 0,1,2 según el input 1,2,3
    const correcta = correctaInput - 1;

    if (!nivel || !texto || !op1 || !op2 || !op3 || isNaN(correcta) || correcta < 0 || correcta > 2) {
      alert("Completa todos los campos correctamente. La opción correcta debe ser 1, 2 o 3.");
      return;
    }

    try {
      const rol = await obtenerRolUsuario();
      if (rol !== "admi") {
        alert("No tienes permisos para guardar preguntas.");
        return;
      }
    } catch (error) {
      alert("Error verificando permisos.");
      console.error(error);
      return;
    }

    const opciones = [op1, op2, op3];

    try {
      const { error } = await supabase.from("preguntas_trivia").insert([
        { nivel, texto, opciones, correcta }
      ]);
      if (error) {
        alert("Error al guardar la pregunta: " + error.message);
        return;
      }
      alert("Pregunta guardada correctamente.");
      // Limpiar inputs
      document.getElementById("texto-pregunta").value = "";
      document.getElementById("op1").value = "";
      document.getElementById("op2").value = "";
      document.getElementById("op3").value = "";
      document.getElementById("correcta").value = "";
      cargarPreguntas(nivel);
    } catch (e) {
      alert("Error inesperado: " + e.message);
      console.error(e);
    }
  });

  // Cargar preguntas al cambiar nivel
  document.getElementById("nivel-pregunta").addEventListener("change", (e) => {
    cargarPreguntas(e.target.value);
  });

  // Inicializar cargas
  (async () => {
    await obtenerRolUsuario();
    cargarPrecios();
    cargarRanking();
    cargarPremios();
    cargarPreguntas(document.getElementById("nivel-pregunta").value);
  })();

</script>
</body>
</html>
