<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trivia - Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #0d1117;
      color: #c9d1d9;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #58a6ff;
    }
    .seccion {
      border: 1px solid #30363d;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
      background-color: #161b22;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, select, button {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 5px;
      border: none;
      background-color: #21262d;
      color: #c9d1d9;
    }
    button {
      background-color: #238636;
      cursor: pointer;
      margin-top: 15px;
    }
    button:hover {
      background-color: #2ea043;
    }
    .pregunta {
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid #30363d;
      border-radius: 5px;
      background-color: #0d1117;
    }
  </style>
</head>
<body>

  <h1>Administrar Trivia</h1>

  <div class="seccion">
    <h2>Agregar Pregunta</h2>
    <label for="nivel-pregunta">Nivel</label>
    <select id="nivel-pregunta">
      <option value="basico">Básico</option>
      <option value="medio">Medio</option>
      <option value="avanzado">Avanzado</option>
    </select>

    <label for="texto-pregunta">Texto de la pregunta</label>
    <input type="text" id="texto-pregunta" />

    <label for="op1">Opción 1</label>
    <input type="text" id="op1" />

    <label for="op2">Opción 2</label>
    <input type="text" id="op2" />

    <label for="op3">Opción 3</label>
    <input type="text" id="op3" />

    <label for="correcta">Número de opción correcta (1, 2 o 3)</label>
    <input type="number" id="correcta" min="1" max="3" />

    <button id="guardar-pregunta">Guardar Pregunta</button>

    <h3>Preguntas guardadas</h3>
    <div id="lista-preguntas"></div>
  </div>

  <div class="seccion">
    <h2>Precios por Nivel</h2>

    <label for="nivel-select">Nivel</label>
    <select id="nivel-select">
      <option value="basico">Básico</option>
      <option value="medio">Medio</option>
      <option value="avanzado">Avanzado</option>
    </select>

    <label for="nuevo-precio">Nuevo precio</label>
    <input type="number" id="nuevo-precio" />

    <button id="guardar-nivel">Guardar Precio</button>

    <h3>Precios actuales</h3>
    <div id="lista-precios"></div>
  </div>
<script>
    // Inicialización única del cliente Supabase
    const supabaseUrl = "https://ovulezkcxwrjvyxlxsdv.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92dWxlemtjeHdyanZ5eGx4c2R2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNzY5OTksImV4cCI6MjA2NDY1Mjk5OX0.ac82tkUR7AT0QVsuzuAGA8SXLkgnM9OX62meYNGnToI";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // Función para cargar precios y mostrarlos en la lista
    async function cargarPrecios() {
      const { data, error } = await supabase.from("niveles_trivia").select("*");
      const lista = document.getElementById("lista-precios");
      lista.innerHTML = "";
      if (error) {
        lista.textContent = "Error al cargar precios: " + error.message;
        return;
      }
      data.forEach(({ nivel, precio }) => {
        const item = document.createElement("div");
        item.textContent = `${nivel}: $${precio}`;
        lista.appendChild(item);
      });
    }

    // Guardar precio nuevo por nivel
    document.getElementById("guardar-nivel").addEventListener("click", async () => {
      const nivel = document.getElementById("nivel-select").value;
      const precio = parseInt(document.getElementById("nuevo-precio").value);
      if (!nivel || isNaN(precio)) {
        alert("Completa todos los campos");
        return;
      }
      const { error } = await supabase.from("niveles_trivia").upsert([{ nivel, precio }]);
      if (error) {
        alert("Error al guardar precio: " + error.message);
        return;
      }
      alert("Precio actualizado");
      cargarPrecios();
    });

    // Guardar pregunta nueva
    document.getElementById("guardar-pregunta").addEventListener("click", async () => {
      const nivel = document.getElementById("nivel-pregunta").value;
      const texto = document.getElementById("texto-pregunta").value.trim();
      const op1 = document.getElementById("op1").value.trim();
      const op2 = document.getElementById("op2").value.trim();
      const op3 = document.getElementById("op3").value.trim();
      const correcta = parseInt(document.getElementById("correcta").value);

      if (!nivel || !texto || !op1 || !op2 || !op3 || isNaN(correcta) || correcta < 1 || correcta > 3) {
        alert("Completa todos los campos correctamente");
        return;
      }

      const opciones = [op1, op2, op3];
      // Guardar correcta como índice base 0
      const correctaIndex = correcta - 1;

      const { error } = await supabase.from("preguntas_trivia").insert([
        { nivel, texto, opciones, correcta: correctaIndex }
      ]);

      if (error) {
        alert("Error al guardar la pregunta: " + error.message);
        return;
      }

      alert("Pregunta guardada");
      // Limpiar formulario
      document.getElementById("texto-pregunta").value = "";
      document.getElementById("op1").value = "";
      document.getElementById("op2").value = "";
      document.getElementById("op3").value = "";
      document.getElementById("correcta").value = "";
      cargarPreguntas(nivel);
    });

    // Cargar preguntas según nivel y mostrarlas en lista
    async function cargarPreguntas(nivel) {
      const { data, error } = await supabase.from("preguntas_trivia").select("*").eq("nivel", nivel);
      const lista = document.getElementById("lista-preguntas");
      lista.innerHTML = "";
      if (error) {
        lista.textContent = "Error al cargar preguntas: " + error.message;
        return;
      }
      data.forEach(p => {
        const div = document.createElement("div");
        div.className = "pregunta";
        div.textContent = `${p.texto} (Opciones: ${p.opciones.join(", ")}) - Correcta: Opción ${p.correcta + 1}`;
        lista.appendChild(div);
      });
    }

    // Cambiar preguntas mostradas al cambiar nivel en selector
    document.getElementById("nivel-pregunta").addEventListener("change", (e) => {
      cargarPreguntas(e.target.value);
    });

    // Cargar ranking de trivia
    async function cargarRanking() {
      const { data, error } = await supabase
        .from("ranking_trivia")
        .select("usuario_id, puntaje")
        .order("puntaje", { ascending: false });

      const tabla = document.getElementById("ranking-trivia");
      if (!tabla) return; // Si no existe tabla (no incluida en tu HTML), evitar error
      tabla.innerHTML = "";
      if (error) {
        const fila = document.createElement("tr");
        fila.innerHTML = `<td colspan="2">Error al cargar ranking: ${error.message}</td>`;
        tabla.appendChild(fila);
        return;
      }
      data.forEach(({ usuario_id, puntaje }) => {
        const fila = document.createElement("tr");
        fila.innerHTML = `<td>${usuario_id}</td><td>${puntaje}</td>`;
        tabla.appendChild(fila);
      });
    }

    // Cargar premios trivia
    async function cargarPremios() {
      const { data, error } = await supabase
        .from("recompensas")
        .select("*")
        .eq("tipo", "trivia")
        .order("fecha", { ascending: false });

      const tabla = document.getElementById("premios-trivia");
      if (!tabla) return; // Si no existe tabla, evitar error
      tabla.innerHTML = "";
      if (error) {
        const fila = document.createElement("tr");
        fila.innerHTML = `<td colspan="5">Error al cargar premios: ${error.message}</td>`;
        tabla.appendChild(fila);
        return;
      }
      data.forEach(p => {
        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td>${p.usuario_id}</td>
          <td>${p.monto}</td>
          <td>${p.moneda}</td>
          <td>${new Date(p.fecha).toLocaleDateString()}</td>
          <td>${p.aprobado ? "✅" : "❌"}</td>
        `;
        tabla.appendChild(fila);
      });
    }

    // Carga inicial
    cargarPrecios();
    cargarRanking();
    cargarPremios();
    cargarPreguntas(document.getElementById("nivel-pregunta").value);
  </script>
</body>
</html>
