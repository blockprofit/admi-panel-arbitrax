<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Minipools - Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #0d1117;
      color: #c9d1d9;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #58a6ff;
    }
    h2 {
      color: #58a6ff;
      margin-bottom: 15px;
    }
    .seccion {
      border: 1px solid #30363d;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
      background-color: #161b22;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
    }
    input, select, button {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 5px;
      border: none;
      background-color: #21262d;
      color: #c9d1d9;
    }
    button {
      background-color: #238636;
      cursor: pointer;
      margin-top: 15px;
      font-weight: 600;
    }
    button:hover {
      background-color: #2ea043;
    }
    .btn-warning {
      background-color: #d1242f;
    }
    .btn-warning:hover {
      background-color: #f85149;
    }
    .btn-secondary {
      background-color: #6e7681;
    }
    .btn-secondary:hover {
      background-color: #8b949e;
    }
    .btn-edit {
      background-color: #58a6ff;
    }
    .btn-edit:hover {
      background-color: #4493f8;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #30363d;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #21262d;
      color: #58a6ff;
      font-weight: 600;
    }
    tr:hover {
      background-color: #0d1117;
    }
    .status {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-pending {
      background-color: #fff3cd;
      color: #856404;
    }
    .status-paid {
      background-color: #d1ecf1;
      color: #0c5460;
    }
    .status-expired {
      background-color: #f8d7da;
      color: #721c24;
    }
    .controls-row {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .control-group {
      flex: 1;
      min-width: 200px;
    }
    .week-nav {
      background-color: #58a6ff;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.2rem;
      margin: 0 5px;
    }
    .week-nav:hover {
      background-color: #4493f8;
    }
    .current-week {
      font-size: 1.1rem;
      font-weight: 600;
      color: #58a6ff;
      padding: 8px 15px;
      background-color: #21262d;
      border-radius: 5px;
      margin: 0 10px;
    }
    .week-selector {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-card {
      background-color: #21262d;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }
    .stat-card h3 {
      color: #58a6ff;
      font-size: 1.8rem;
      margin-bottom: 5px;
    }
    .stat-card p {
      color: #8b949e;
      font-size: 0.9rem;
    }
    .pool-header {
      background-color: #238636;
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .pool-actions {
      display: flex;
      gap: 10px;
    }
    .pool-actions button {
      width: auto;
      padding: 6px 12px;
      margin: 0;
      font-size: 0.8rem;
    }
    .action-buttons {
      display: flex;
      gap: 5px;
    }
    .action-buttons button {
      width: auto;
      padding: 4px 8px;
      margin: 0;
      font-size: 0.7rem;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #58a6ff;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .success {
      background-color: #d1ecf1;
      color: #0c5460;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .pool-config {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .pool-card {
      background-color: #21262d;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 15px;
    }
    .pool-card h4 {
      color: #58a6ff;
      margin-bottom: 10px;
    }
    .price-input {
      display: flex;
      gap: 10px;
      align-items: end;
    }
    .price-input input {
      flex: 1;
      margin: 0;
    }
    .price-input button {
      width: auto;
      padding: 8px 12px;
      margin: 0;
    }
    @media (max-width: 768px) {
      .controls-row {
        flex-direction: column;
      }
      .pool-header {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .pool-config {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <h1>Administrar Minipools</h1>

  <!-- Selector de Semana -->
  <div class="seccion">
    <div class="week-selector">
      <button class="week-nav" onclick="changeWeek(-1)">‚Äπ</button>
      <div class="current-week" id="currentWeek">Cargando...</div>
      <button class="week-nav" onclick="changeWeek(1)">‚Ä∫</button>
    </div>
  </div>

  <!-- Estad√≠sticas -->
  <div class="seccion">
    <h2>üìä Estad√≠sticas de la Semana</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <h3 id="totalParticipants">0</h3>
        <p>Total Participantes</p>
      </div>
      <div class="stat-card">
        <h3 id="totalInvested">$0</h3>
        <p>Total Invertido (ARS)</p>
      </div>
      <div class="stat-card">
        <h3 id="pendingPayments">$0</h3>
        <p>Pagos Pendientes</p>
      </div>
      <div class="stat-card">
        <h3 id="weekProfit">$0</h3>
        <p>Ganancia Semana</p>
      </div>
    </div>
  </div>

  <!-- Configuraci√≥n de Precios -->
  <div class="seccion">
    <h2>üí∞ Configurar Precios de Minipools</h2>
    <div class="pool-config">
      <div class="pool-card">
        <h4>ü•â Minipool B√°sico</h4>
        <div class="price-input">
          <input type="number" id="priceBasico" placeholder="10000" value="10000">
          <button class="btn-edit" onclick="updatePoolPrice('minipool_basico')">üíæ Guardar</button>
        </div>
        <p>Precio actual: <span id="currentPriceBasico">$10,000</span></p>
      </div>
      
      <div class="pool-card">
        <h4>ü•à Minipool Medio</h4>
        <div class="price-input">
          <input type="number" id="priceMedio" placeholder="25000" value="25000">
          <button class="btn-edit" onclick="updatePoolPrice('minipool_medio')">üíæ Guardar</button>
        </div>
        <p>Precio actual: <span id="currentPriceMedio">$25,000</span></p>
      </div>
      
      <div class="pool-card">
        <h4>ü•á Minipool Avanzado</h4>
        <div class="price-input">
          <input type="number" id="priceAvanzado" placeholder="50000" value="50000">
          <button class="btn-edit" onclick="updatePoolPrice('minipool_avanzado')">üíæ Guardar</button>
        </div>
        <p>Precio actual: <span id="currentPriceAvanzado">$50,000</span></p>
      </div>
    </div>
  </div>

  <!-- Controles de B√∫squeda y Filtros -->
  <div class="seccion">
    <h2>üîç Filtros y B√∫squeda</h2>
    <div class="controls-row">
      <div class="control-group">
        <label for="searchInput">Buscar por Usuario ID:</label>
        <input type="text" id="searchInput" placeholder="Ingresa ID de usuario..." onkeyup="filterParticipants()">
      </div>
      
      <div class="control-group">
        <label for="statusFilter">Filtrar por Estado:</label>
        <select id="statusFilter" onchange="filterParticipants()">
          <option value="">Todos los estados</option>
          <option value="false">Pendiente</option>
          <option value="true">Pagado</option>
        </select>
      </div>

      <div class="control-group">
        <label for="typeFilter">Filtrar por Tipo:</label>
        <select id="typeFilter" onchange="filterParticipants()">
          <option value="">Todos los tipos</option>
          <option value="minipool_basico">Minipool B√°sico</option>
          <option value="minipool_medio">Minipool Medio</option>
          <option value="minipool_avanzado">Minipool Avanzado</option>
        </select>
      </div>
    </div>
    
    <button onclick="processAllPayments()">üí∞ Procesar Todos los Pagos Vencidos</button>
    <button onclick="refreshData()" class="btn-secondary">üîÑ Actualizar Datos</button>
  </div>

  <!-- Crear Nuevo Pool -->
  <div class="seccion">
    <h2>‚ûï Crear Nueva Inversi√≥n de Prueba</h2>
    
    <label for="poolType">Tipo de Minipool:</label>
    <select id="poolType">
      <option value="minipool_basico">ü•â Minipool B√°sico</option>
      <option value="minipool_medio">ü•à Minipool Medio</option>
      <option value="minipool_avanzado">ü•á Minipool Avanzado</option>
    </select>
    
    <label for="testUserId">ID Usuario de Prueba:</label>
    <input type="text" id="testUserId" placeholder="user-test-001">
    
    <button onclick="createTestInvestment()">üèä‚Äç‚ôÇÔ∏è Crear Inversi√≥n de Prueba</button>
  </div>

  <!-- Tabla de Todas las Inversiones -->
  <div class="seccion">
    <h2>üèä‚Äç‚ôÇÔ∏è Todas las Inversiones Activas</h2>
    <div id="loadingMessage" class="loading">Cargando inversiones...</div>
    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>
    
    <table id="investmentsTable" style="display: none;">
      <thead>
        <tr>
          <th>ID</th>
          <th>Usuario ID</th>
          <th>Tipo Pool</th>
          <th>Monto Invertido</th>
          <th>Moneda</th>
          <th>Fecha Inversi√≥n</th>
          <th>Monto a Pagar</th>
          <th>Fecha Vencimiento</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="investmentsTableBody">
        <!-- Los datos se cargar√°n aqu√≠ -->
      </tbody>
    </table>
  </div>

  <!-- Historial de Transacciones -->
  <div class="seccion">
    <h2>üìã Historial de Todas las Recompensas</h2>
    <table id="historyTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Usuario</th>
          <th>Tipo</th>
          <th>Monto</th>
          <th>Moneda</th>
          <th>Fecha</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody id="historyTableBody">
        <!-- Las transacciones se cargar√°n aqu√≠ -->
      </tbody>
    </table>
  </div>

</body>
</html>

<script>
  const supabaseUrl = "https://ovulezkcxwrjvyxlxsdv.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92dWxlemtjeHdyanZ5eGx4c2R2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNzY5OTksImV4cCI6MjA2NDY1Mjk5OX0.ac82tkUR7AT0QVsuzuAGA8SXLkgnM9OX62meYNGnToI";
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  // Variables globales
  let rolUsuario = null;
  let currentWeekOffset = 0;
  let allInvestments = [];

  // Configuraci√≥n de pools (EDITABLE)
  let poolConfig = {
    'minipool_basico': { 
      name: 'Minipool B√°sico', 
      icon: 'ü•â',
      amount: 10000, 
      returnRate: 100 
    },
    'minipool_medio': { 
      name: 'Minipool Medio', 
      icon: 'ü•à',
      amount: 25000, 
      returnRate: 100 
    },
    'minipool_avanzado': { 
      name: 'Minipool Avanzado', 
      icon: 'ü•á',
      amount: 50000, 
      returnRate: 100 
    }
  };

  // Funciones de utilidad
  function showMessage(message, type = 'success') {
    const successEl = document.getElementById('successMessage');
    const errorEl = document.getElementById('errorMessage');
    
    if (type === 'success') {
      successEl.textContent = message;
      successEl.style.display = 'block';
      errorEl.style.display = 'none';
    } else {
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      successEl.style.display = 'none';
    }
    
    setTimeout(() => {
      successEl.style.display = 'none';
      errorEl.style.display = 'none';
    }, 5000);
  }

  function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('es-AR', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  function formatCurrency(amount) {
    return new Intl.NumberFormat('es-AR', {
      style: 'currency',
      currency: 'ARS',
      minimumFractionDigits: 0
    }).format(amount);
  }

  function addDaysToDate(date, days) {
    const result = new Date(date);
    result.setDate(result.getDate() + days);
    return result;
  }

  function getWeekRange(weekOffset = 0) {
    const today = new Date();
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - today.getDay() + (weekOffset * 7));
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    
    return {
      start: startOfWeek,
      end: endOfWeek,
      formatted: `${startOfWeek.toLocaleDateString('es-AR')} al ${endOfWeek.toLocaleDateString('es-AR')}`
    };
  }

  // Verificar permisos de usuario
  async function obtenerRolUsuario() {
    try {
      const { data: authData, error: authError } = await supabaseClient.auth.getUser();
      if (authError || !authData.user) {
        showMessage("No est√°s autenticado. Por favor inicia sesi√≥n.", 'error');
        throw new Error("No autenticado");
      }
      const userId = authData.user.id;

      const { data: perfilData, error: perfilError } = await supabaseClient
        .from("profiles")
        .select("rol")
        .eq("id", userId)
        .single();

      if (perfilError || !perfilData) {
        showMessage("Error obteniendo perfil de usuario.", 'error');
        throw new Error("Error perfil");
      }

      rolUsuario = perfilData.rol;
      return rolUsuario;
    } catch (e) {
      console.error(e);
      return null;
    }
  }

  // Actualizar precios de pools
  async function updatePoolPrice(poolType) {
    try {
      const rol = await obtenerRolUsuario();
      if (rol !== "admi") {
        showMessage("No tienes permisos para cambiar precios.", 'error');
        return;
      }
    } catch (error) {
      showMessage("Error verificando permisos.", 'error');
      return;
    }

    const inputMap = {
      'minipool_basico': 'priceBasico',
      'minipool_medio': 'priceMedio',
      'minipool_avanzado': 'priceAvanzado'
    };

    const currentSpanMap = {
      'minipool_basico': 'currentPriceBasico',
      'minipool_medio': 'currentPriceMedio',
      'minipool_avanzado': 'currentPriceAvanzado'
    };

    const inputId = inputMap[poolType];
    const spanId = currentSpanMap[poolType];
    const newPrice = parseInt(document.getElementById(inputId).value);

    if (!newPrice || newPrice <= 0) {
      showMessage("Ingresa un precio v√°lido mayor a 0.", 'error');
      return;
    }

    if (!confirm(`¬øConfirmar cambio de precio del ${poolConfig[poolType].name} a ${formatCurrency(newPrice)}?`)) {
      return;
    }

    try {
      // Actualizar configuraci√≥n local
      poolConfig[poolType].amount = newPrice;
      
      // Actualizar interfaz
      document.getElementById(spanId).textContent = formatCurrency(newPrice);
      
      // Aqu√≠ podr√≠as guardar en Supabase si quieres persistir los cambios
      // Por ahora solo se mantiene en memoria durante la sesi√≥n
      
      showMessage(`‚úÖ Precio del ${poolConfig[poolType].name} actualizado a ${formatCurrency(newPrice)}`);
      
      // Recargar datos para reflejar cambios
      await refreshData();
      
    } catch (error) {
      console.error('Error actualizando precio:', error);
      showMessage('Error actualizando precio: ' + error.message, 'error');
    }
  }

  // Actualizar interfaz de precios
  function updatePriceInterface() {
    Object.keys(poolConfig).forEach(poolType => {
      const inputMap = {
        'minipool_basico': 'priceBasico',
        'minipool_medio': 'priceMedio',
        'minipool_avanzado': 'priceAvanzado'
      };

      const currentSpanMap = {
        'minipool_basico': 'currentPriceBasico',
        'minipool_medio': 'currentPriceMedio',
        'minipool_avanzado': 'currentPriceAvanzado'
      };

      const inputId = inputMap[poolType];
      const spanId = currentSpanMap[poolType];
      
      if (document.getElementById(inputId)) {
        document.getElementById(inputId).value = poolConfig[poolType].amount;
      }
      
      if (document.getElementById(spanId)) {
        document.getElementById(spanId).textContent = formatCurrency(poolConfig[poolType].amount);
      }
    });
  }

  // Cargar datos desde Supabase
  async function loadInvestments() {
    try {
      document.getElementById('loadingMessage').style.display = 'block';
      document.getElementById('investmentsTable').style.display = 'none';

      const { data, error } = await supabaseClient
        .from('recompensas')
        .select('*')
        .in('tipo', ['minipool_basico', 'minipool_medio', 'minipool_avanzado'])
        .order('fecha', { ascending: false });

      if (error) {
        throw error;
      }

      allInvestments = data || [];
      renderInvestmentsTable();
      updateStatistics();
      
      document.getElementById('loadingMessage').style.display = 'none';
      document.getElementById('investmentsTable').style.display = 'table';

    } catch (error) {
      console.error('Error cargando inversiones:', error);
      showMessage('Error cargando datos: ' + error.message, 'error');
      document.getElementById('loadingMessage').style.display = 'none';
    }
  }

// Renderizar tabla de inversiones
  function renderInvestmentsTable() {
    const tbody = document.getElementById('investmentsTableBody');
    tbody.innerHTML = '';

    if (allInvestments.length === 0) {
      tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">No hay inversiones registradas</td></tr>';
      return;
    }

    allInvestments.forEach(investment => {
      const row = createInvestmentRow(investment);
      tbody.appendChild(row);
    });
  }

  function createInvestmentRow(investment) {
    const row = document.createElement('tr');
    const expirationDate = addDaysToDate(new Date(investment.fecha), 7);
    const returnAmount = investment.monto * 2; // Duplica la inversi√≥n
    const isExpired = new Date() > expirationDate && !investment.aprobado;
    
    row.setAttribute('data-user-id', investment.usuario_id || '');
    row.setAttribute('data-status', investment.aprobado.toString());
    row.setAttribute('data-type', investment.tipo || '');

    const poolInfo = poolConfig[investment.tipo] || { name: investment.tipo, icon: 'üèä‚Äç‚ôÇÔ∏è' };

    row.innerHTML = `
      <td>${investment.id}</td>
      <td>${investment.usuario_id || 'N/A'}</td>
      <td>${poolInfo.icon} ${poolInfo.name}</td>
      <td>${formatCurrency(investment.monto)}</td>
      <td>${investment.moneda}</td>
      <td>${formatDate(investment.fecha)}</td>
      <td>${formatCurrency(returnAmount)}</td>
      <td>${formatDate(expirationDate)}</td>
      <td>
        <span class="status ${investment.aprobado ? 'status-paid' : (isExpired ? 'status-expired' : 'status-pending')}">
          ${investment.aprobado ? 'Pagado' : (isExpired ? 'Vencido' : 'Pendiente')}
        </span>
      </td>
      <td>
        <div class="action-buttons">
          ${!investment.aprobado ? 
            `<button onclick="markAsPaid('${investment.id}')">‚úÖ Pagar</button>` : 
            ''
          }
          <button class="btn-secondary" onclick="viewDetails('${investment.id}')">üëÅÔ∏è Ver</button>
        </div>
      </td>
    `;
    
    return row;
  }

  // Actualizar estad√≠sticas
  function updateStatistics() {
    const weekRange = getWeekRange(currentWeekOffset);
    const weekStart = weekRange.start.toISOString();
    const weekEnd = new Date(weekRange.end);
    weekEnd.setHours(23, 59, 59, 999);
    const weekEndStr = weekEnd.toISOString();

    const weekInvestments = allInvestments.filter(inv => {
      const invDate = new Date(inv.fecha);
      return invDate >= new Date(weekStart) && invDate <= new Date(weekEndStr);
    });

    const totalParticipants = weekInvestments.length;
    const totalInvested = weekInvestments.reduce((sum, inv) => sum + Number(inv.monto), 0);
    const pendingPayments = weekInvestments
      .filter(inv => !inv.aprobado)
      .reduce((sum, inv) => sum + (Number(inv.monto) * 2), 0);
    const weekProfit = totalInvested - pendingPayments;

    document.getElementById('currentWeek').textContent = `Semana del ${weekRange.formatted}`;
    document.getElementById('totalParticipants').textContent = totalParticipants;
    document.getElementById('totalInvested').textContent = formatCurrency(totalInvested);
    document.getElementById('pendingPayments').textContent = formatCurrency(pendingPayments);
    document.getElementById('weekProfit').textContent = formatCurrency(weekProfit);
  }

  // Navegaci√≥n de semanas
  function changeWeek(direction) {
    currentWeekOffset += direction;
    updateStatistics();
  }

  // Filtrar inversiones
  function filterParticipants() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    
    const rows = document.querySelectorAll('#investmentsTableBody tr');
    
    rows.forEach(row => {
      const userId = row.getAttribute('data-user-id') || '';
      const status = row.getAttribute('data-status') || '';
      const type = row.getAttribute('data-type') || '';

      const matchesSearch = userId.toLowerCase().includes(searchTerm);
      const matchesStatus = !statusFilter || status === statusFilter;
      const matchesType = !typeFilter || type === typeFilter;

      if (matchesSearch && matchesStatus && matchesType) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  }

  // Marcar como pagado
  async function markAsPaid(investmentId) {
    try {
      const rol = await obtenerRolUsuario();
      if (rol !== "admi") {
        showMessage("No tienes permisos para procesar pagos.", 'error');
        return;
      }
    } catch (error) {
      showMessage("Error verificando permisos.", 'error');
      return;
    }

    if (!confirm(`¬øConfirmar pago para la inversi√≥n ${investmentId}?`)) {
      return;
    }

    try {
      const { data, error } = await supabaseClient
        .from('recompensas')
        .update({ 
          aprobado: true,
          meta: new Date().getTime() // Marcamos cu√°ndo se aprob√≥
        })
        .eq('id', investmentId);

      if (error) throw error;

      showMessage(`Pago procesado exitosamente para inversi√≥n ${investmentId}`);
      await refreshData();

    } catch (error) {
      console.error('Error procesando pago:', error);
      showMessage('Error procesando el pago: ' + error.message, 'error');
    }
  }

  // Ver detalles
  function viewDetails(investmentId) {
    const investment = allInvestments.find(inv => inv.id === investmentId);
    if (!investment) {
      showMessage('Inversi√≥n no encontrada', 'error');
      return;
    }

    const expirationDate = addDaysToDate(new Date(investment.fecha), 7);
    const returnAmount = investment.monto * 2;
    const poolInfo = poolConfig[investment.tipo] || { name: investment.tipo, icon: 'üèä‚Äç‚ôÇÔ∏è' };
    
    alert(`üìã Detalles de la Inversi√≥n
    
ID: ${investment.id}
Usuario: ${investment.usuario_id}
Tipo: ${poolInfo.icon} ${poolInfo.name}
Monto Invertido: ${formatCurrency(investment.monto)} ${investment.moneda}
Fecha Inversi√≥n: ${formatDate(investment.fecha)}
Monto a Devolver: ${formatCurrency(returnAmount)}
Fecha Vencimiento: ${formatDate(expirationDate)}
Estado: ${investment.aprobado ? 'Pagado' : 'Pendiente'}
Meta: ${investment.meta || 'N/A'}`);
  }

  // Procesar todos los pagos vencidos
  async function processAllPayments() {
    try {
      const rol = await obtenerRolUsuario();
      if (rol !== "admi") {
        showMessage("No tienes permisos para procesar pagos masivos.", 'error');
        return;
      }
    } catch (error) {
      showMessage("Error verificando permisos.", 'error');
      return;
    }

    const pendingExpired = allInvestments.filter(inv => {
      if (inv.aprobado) return false;
      const expirationDate = addDaysToDate(new Date(inv.fecha), 7);
      return new Date() > expirationDate;
    });

    if (pendingExpired.length === 0) {
      showMessage('No hay pagos vencidos para procesar');
      return;
    }

    if (!confirm(`¬øConfirmar procesamiento de ${pendingExpired.length} pagos vencidos?`)) {
      return;
    }

    try {
      const updates = pendingExpired.map(inv => ({
        id: inv.id,
        aprobado: true,
        meta: new Date().getTime()
      }));

      for (const update of updates) {
        const { error } = await supabaseClient
          .from('recompensas')
          .update({ 
            aprobado: update.aprobado,
            meta: update.meta
          })
          .eq('id', update.id);
        
        if (error) throw error;
      }

      showMessage(`Se procesaron ${updates.length} pagos exitosamente.`);
      await refreshData();

    } catch (error) {
      console.error('Error procesando pagos masivos:', error);
      showMessage('Error procesando pagos: ' + error.message, 'error');
    }
  }

  // Crear inversi√≥n de prueba
  async function createTestInvestment() {
    try {
      const rol = await obtenerRolUsuario();
      if (rol !== "admi") {
        showMessage("No tienes permisos para crear inversiones.", 'error');
        return;
      }
    } catch (error) {
      showMessage("Error verificando permisos.", 'error');
      return;
    }

    const type = document.getElementById('poolType').value;
    const userId = document.getElementById('testUserId').value.trim();

    if (!userId) {
      showMessage("Ingresa un ID de usuario.", 'error');
      return;
    }

    const poolInfo = poolConfig[type];
    if (!poolInfo) {
      showMessage("Tipo de pool inv√°lido.", 'error');
      return;
    }

    try {
      const { data, error } = await supabaseClient
        .from('recompensas')
        .insert({
          usuario_id: userId,
          meta: poolInfo.returnRate,
          fecha: new Date().toISOString(),
          monto: poolInfo.amount,
          moneda: 'ARS',
          aprobado: false,
          tipo: type
        });

      if (error) throw error;

      showMessage(`Inversi√≥n de prueba creada exitosamente!\nTipo: ${poolInfo.icon} ${poolInfo.name}\nMonto: ${formatCurrency(poolInfo.amount)}\nUsuario: ${userId}`);
      
      document.getElementById('testUserId').value = '';
      await refreshData();

    } catch (error) {
      console.error('Error creando inversi√≥n:', error);
      showMessage('Error creando inversi√≥n: ' + error.message, 'error');
    }
  }

  // Cargar historial
  async function loadHistory() {
    try {
      const { data, error } = await supabaseClient
        .from('recompensas')
        .select('*')
        .order('fecha', { ascending: false })
        .limit(50);

      if (error) throw error;

      const tbody = document.getElementById('historyTableBody');
      tbody.innerHTML = '';

      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No hay historial disponible</td></tr>';
        return;
      }

      data.forEach(item => {
        const row = document.createElement('tr');
        const poolInfo = poolConfig[item.tipo] || { name: item.tipo, icon: 'üèä‚Äç‚ôÇÔ∏è' };
        
        row.innerHTML = `
          <td>${item.id}</td>
          <td>${item.usuario_id || 'N/A'}</td>
          <td>${poolInfo.icon} ${poolInfo.name}</td>
          <td>${formatCurrency(item.monto)}</td>
          <td>${item.moneda}</td>
          <td>${formatDate(item.fecha)}</td>
          <td>
            <span class="status ${item.aprobado ? 'status-paid' : 'status-pending'}">
              ${item.aprobado ? 'Pagado' : 'Pendiente'}
            </span>
          </td>
        `;
        tbody.appendChild(row);
      });

    } catch (error) {
      console.error('Error cargando historial:', error);
      const tbody = document.getElementById('historyTableBody');
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #f85149;">Error cargando historial</td></tr>';
    }
  }

  // Refrescar todos los datos
  async function refreshData() {
    try {
      await Promise.all([
        loadInvestments(),
        loadHistory()
      ]);
      updatePriceInterface();
      showMessage('Datos actualizados correctamente');
    } catch (error) {
      console.error('Error refrescando datos:', error);
      showMessage('Error actualizando datos: ' + error.message, 'error');
    }
  }

  // Verificar vencimientos autom√°ticamente
  function checkExpirations() {
    const now = new Date();
    let expiredCount = 0;

    allInvestments.forEach(investment => {
      if (!investment.aprobado) {
        const expirationDate = addDaysToDate(new Date(investment.fecha), 7);
        if (now > expirationDate) {
          expiredCount++;
        }
      }
    });

    if (expiredCount > 0) {
      console.log(`‚ö†Ô∏è Hay ${expiredCount} pagos vencidos pendientes de procesamiento`);
    }
  }

  // Inicializar aplicaci√≥n
  async function initializeApp() {
    try {
      console.log('üèä‚Äç‚ôÇÔ∏è Iniciando Panel de Minipools...');
      
      // Verificar autenticaci√≥n y permisos
      const rol = await obtenerRolUsuario();
      if (!rol) {
        showMessage('Error de autenticaci√≥n. Recarga la p√°gina.', 'error');
        return;
      }

      if (rol !== 'admi') {
        showMessage('No tienes permisos de administrador.', 'error');
        return;
      }

      // Inicializar interfaz de precios
      updatePriceInterface();

      // Cargar datos iniciales
      await refreshData();
      
      // Verificar vencimientos
      checkExpirations();
      
      // Configurar verificaci√≥n autom√°tica cada 5 minutos
      setInterval(checkExpirations, 5 * 60 * 1000);
      
      console.log('üìä Sistema de Minipools cargado correctamente');
      console.log('‚úÖ Panel listo para gestionar inversiones semanales');
      console.log('üí∞ Configuraci√≥n de precios:', poolConfig);
      
    } catch (error) {
      console.error('Error inicializando aplicaci√≥n:', error);
      showMessage('Error inicializando el sistema: ' + error.message, 'error');
    }
  }

  // Event listeners adicionales
  document.addEventListener('DOMContentLoaded', initializeApp);

  // Manejar actualizaciones en tiempo real (opcional)
  const realtimeSubscription = supabaseClient
    .channel('recompensas_changes')
    .on('postgres_changes', 
      { 
        event: '*', 
        schema: 'public', 
        table: 'recompensas',
        filter: 'tipo=in.(minipool_basico,minipool_medio,minipool_avanzado)'
      }, 
      (payload) => {
        console.log('üì° Cambio detectado en tiempo real:', payload);
        // Recargar datos despu√©s de un cambio
        setTimeout(() => refreshData(), 1000);
      }
    )
    .subscribe();

  // Funciones globales para acceso desde HTML
  window.changeWeek = changeWeek;
  window.filterParticipants = filterParticipants;
  window.markAsPaid = markAsPaid;
  window.viewDetails = viewDetails;
  window.processAllPayments = processAllPayments;
  window.createTestInvestment = createTestInvestment;
  window.refreshData = refreshData;
  window.updatePoolPrice = updatePoolPrice;

</script>
</body>
</html>
