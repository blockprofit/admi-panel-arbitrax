<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Minipools - Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #0d1117;
      color: #c9d1d9;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #58a6ff;
    }
    h2 {
      color: #58a6ff;
      margin-bottom: 15px;
    }
    .seccion {
      border: 1px solid #30363d;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
      background-color: #161b22;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
    }
    input, select, button {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 5px;
      border: none;
      background-color: #21262d;
      color: #c9d1d9;
    }
    button {
      background-color: #238636;
      cursor: pointer;
      margin-top: 15px;
      font-weight: 600;
    }
    button:hover {
      background-color: #2ea043;
    }
    .btn-warning {
      background-color: #d1242f;
    }
    .btn-warning:hover {
      background-color: #f85149;
    }
    .btn-secondary {
      background-color: #6e7681;
    }
    .btn-secondary:hover {
      background-color: #8b949e;
    }
    .btn-edit {
      background-color: #58a6ff;
    }
    .btn-edit:hover {
      background-color: #4493f8;
    }
    .btn-approve {
      background-color: #238636;
      color: white;
    }
    .btn-approve:hover {
      background-color: #2ea043;
    }
    .btn-reject {
      background-color: #d1242f;
      color: white;
    }
    .btn-reject:hover {
      background-color: #f85149;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #30363d;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #21262d;
      color: #58a6ff;
      font-weight: 600;
    }
    tr:hover {
      background-color: #0d1117;
    }
    .status {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-pending {
      background-color: #fff3cd;
      color: #856404;
    }
    .status-approved {
      background-color: #d1ecf1;
      color: #0c5460;
    }
    .status-rejected {
      background-color: #f8d7da;
      color: #721c24;
    }
    .status-pagado {
      background-color: #d1ecf1;
      color: #0c5460;
    }
    .controls-row {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .control-group {
      flex: 1;
      min-width: 200px;
    }
    .week-nav {
      background-color: #58a6ff;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.2rem;
      margin: 0 5px;
    }
    .week-nav:hover {
      background-color: #4493f8;
    }
    .current-week {
      font-size: 1.1rem;
      font-weight: 600;
      color: #58a6ff;
      padding: 8px 15px;
      background-color: #21262d;
      border-radius: 5px;
      margin: 0 10px;
    }
    .week-selector {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-card {
      background-color: #21262d;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }
    .stat-card h3 {
      color: #58a6ff;
      font-size: 1.8rem;
      margin-bottom: 5px;
    }
    .stat-card p {
      color: #8b949e;
      font-size: 0.9rem;
    }
    .action-buttons {
      display: flex;
      gap: 5px;
    }
    .action-buttons button {
      width: auto;
      padding: 4px 8px;
      margin: 0;
      font-size: 0.7rem;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #58a6ff;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .success {
      background-color: #d1ecf1;
      color: #0c5460;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .pool-config {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .pool-card {
      background-color: #21262d;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 15px;
    }
    .pool-card h4 {
      color: #58a6ff;
      margin-bottom: 10px;
    }
    .price-input {
      display: flex;
      gap: 10px;
      align-items: end;
    }
    .price-input input {
      flex: 1;
      margin: 0;
    }
    .price-input button {
      width: auto;
      padding: 8px 12px;
      margin: 0;
    }
    .pending-requests {
      background-color: #fff3cd;
      color: #856404;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #ffeaa7;
    }
    .pending-count {
      font-size: 1.2rem;
      font-weight: bold;
    }
    @media (max-width: 768px) {
      .controls-row {
        flex-direction: column;
      }
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .pool-config {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <h1>Administrar Minipools</h1>

  <!-- Alerta de solicitudes pendientes -->
  <div class="pending-requests" id="pendingAlert" style="display: none;">
    <span class="pending-count" id="pendingCount">0</span> solicitudes de minipool pendientes de aprobaci√≥n.
  </div>

  <!-- Selector de Semana -->
  <div class="seccion">
    <div class="week-selector">
      <button class="week-nav" onclick="changeWeek(-1)">‚Äπ</button>
      <div class="current-week" id="currentWeek">Cargando...</div>
      <button class="week-nav" onclick="changeWeek(1)">‚Ä∫</button>
    </div>
  </div>

  <!-- Estad√≠sticas -->
  <div class="seccion">
    <h2>üìä Estad√≠sticas de la Semana</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <h3 id="totalParticipants">0</h3>
        <p>Total Participantes</p>
      </div>
      <div class="stat-card">
        <h3 id="totalInvested">$0</h3>
        <p>Total Invertido (ARS)</p>
      </div>
      <div class="stat-card">
        <h3 id="pendingPayments">$0</h3>
        <p>Pendientes de Aprobaci√≥n</p>
      </div>
      <div class="stat-card">
        <h3 id="weekProfit">$0</h3>
        <p>Pagos Procesados</p>
      </div>
    </div>
  </div>

  <!-- Configuraci√≥n de Precios -->
  <div class="seccion">
    <h2>üí∞ Configurar Precios de Minipools</h2>
    <div class="pool-config">
      <div class="pool-card">
        <h4>ü•â Minipool B√°sico</h4>
        <div class="price-input">
          <input type="number" id="priceBasico" placeholder="10000" value="10000">
          <button class="btn-edit" onclick="updatePoolPrice('basico')">üíæ Guardar</button>
        </div>
        <p>Precio actual: <span id="currentPriceBasico">$10,000</span></p>
      </div>
      
      <div class="pool-card">
        <h4>ü•à Minipool Medio</h4>
        <div class="price-input">
          <input type="number" id="priceMedio" placeholder="25000" value="25000">
          <button class="btn-edit" onclick="updatePoolPrice('medio')">üíæ Guardar</button>
        </div>
        <p>Precio actual: <span id="currentPriceMedio">$25,000</span></p>
      </div>
      
      <div class="pool-card">
        <h4>ü•á Minipool Avanzado</h4>
        <div class="price-input">
          <input type="number" id="priceAvanzado" placeholder="50000" value="50000">
          <button class="btn-edit" onclick="updatePoolPrice('avanzado')">üíæ Guardar</button>
        </div>
        <p>Precio actual: <span id="currentPriceAvanzado">$50,000</span></p>
      </div>
    </div>
  </div>

  <!-- Controles de B√∫squeda y Filtros -->
  <div class="seccion">
    <h2>üîç Gesti√≥n de Solicitudes</h2>
    <div class="controls-row">
      <div class="control-group">
        <label for="searchInput">Buscar por Usuario o Email:</label>
        <input type="text" id="searchInput" placeholder="Ingresa ID de usuario o email..." onkeyup="filterParticipants()">
      </div>
      
      <div class="control-group">
        <label for="statusFilter">Filtrar por Estado:</label>
        <select id="statusFilter" onchange="filterParticipants()">
          <option value="">Todos los estados</option>
          <option value="pendiente">Pendiente</option>
          <option value="pagado">Pagado</option>
          <option value="rechazado">Rechazado</option>
        </select>
      </div>

      <div class="control-group">
        <label for="levelFilter">Filtrar por Nivel:</label>
        <select id="levelFilter" onchange="filterParticipants()">
          <option value="">Todos los niveles</option>
          <option value="basico">B√°sico</option>
          <option value="medio">Medio</option>
          <option value="avanzado">Avanzado</option>
        </select>
      </div>
    </div>
    
    <button onclick="processAllPendingRequests()">‚úÖ Aprobar Todas las Solicitudes Pendientes</button>
    <button onclick="refreshData()" class="btn-secondary">üîÑ Actualizar Datos</button>
  </div>

  <!-- Tabla de Solicitudes -->
  <div class="seccion">
    <h2>üèä‚Äç‚ôÇÔ∏è Solicitudes de Minipools</h2>
    <div id="loadingMessage" class="loading">Cargando solicitudes...</div>
    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>
    
    <table id="requestsTable" style="display: none;">
      <thead>
        <tr>
          <th>ID</th>
          <th>Usuario</th>
          <th>Email</th>
          <th>Nivel</th>
          <th>Monto</th>
          <th>Fecha Entrada</th>
          <th>Vencimiento</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="requestsTableBody">
        <!-- Los datos se cargar√°n aqu√≠ -->
      </tbody>
    </table>
  </div>

  <!-- Historial de Transacciones -->
  <div class="seccion">
    <h2>üìã Historial de Pagos Procesados</h2>
    <table id="historyTable">
      <thead>
        <tr>
          <th>Usuario</th>
          <th>Email</th>
          <th>Nivel</th>
          <th>Monto Original</th>
          <th>Monto Pagado</th>
          <th>Fecha Pago</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody id="historyTableBody">
        <!-- Las transacciones se cargar√°n aqu√≠ -->
      </tbody>
    </table>
  </div>

</body>
</html>

<script>
  const supabaseUrl = "https://ovulezkcxwrjvyxlxsdv.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92dWxlemtjeHdyanZ5eGx4c2R2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNzY5OTksImV4cCI6MjA2NDY1Mjk5OX0.ac82tkUR7AT0QVsuzuAGA8SXLkgnM9OX62meYNGnToI";
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  // Variables globales
  let rolUsuario = null;
  let currentWeekOffset = 0;
  let allRequests = [];
  let currentUser = null;

  // Configuraci√≥n de pools (EDITABLE - Se guarda en memoria durante la sesi√≥n)
  let poolConfig = {
    'basico': { 
      name: 'Minipool B√°sico', 
      icon: 'ü•â',
      amount: 10000, 
      returnRate: 100 
    },
    'medio': { 
      name: 'Minipool Medio', 
      icon: 'ü•à',
      amount: 25000, 
      returnRate: 100 
    },
    'avanzado': { 
      name: 'Minipool Avanzado', 
      icon: 'ü•á',
      amount: 50000, 
      returnRate: 100 
    }
  };

  // Funciones de utilidad
  function showMessage(message, type = 'success') {
    const successEl = document.getElementById('successMessage');
    const errorEl = document.getElementById('errorMessage');
    
    if (type === 'success') {
      successEl.textContent = message;
      successEl.style.display = 'block';
      errorEl.style.display = 'none';
    } else {
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      successEl.style.display = 'none';
    }
    
    setTimeout(() => {
      successEl.style.display = 'none';
      errorEl.style.display = 'none';
    }, 5000);
  }

  function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('es-AR', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  function formatCurrency(amount) {
    return new Intl.NumberFormat('es-AR', {
      style: 'currency',
      currency: 'ARS',
      minimumFractionDigits: 0
    }).format(amount);
  }

  function addDaysToDate(date, days) {
    const result = new Date(date);
    result.setDate(result.getDate() + days);
    return result;
  }

  function getWeekRange(weekOffset = 0) {
    const today = new Date();
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - today.getDay() + (weekOffset * 7));
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    
    return {
      start: startOfWeek,
      end: endOfWeek,
      formatted: `${startOfWeek.toLocaleDateString('es-AR')} al ${endOfWeek.toLocaleDateString('es-AR')}`
    };
  }

  // Verificar permisos de usuario
  async function obtenerRolUsuario() {
    try {
      const { data: authData, error: authError } = await supabaseClient.auth.getUser();
      if (authError || !authData.user) {
        showMessage("Error de autenticaci√≥n. Por favor inicia sesi√≥n.", 'error');
        throw new Error("No autenticado");
      }
      
      currentUser = authData.user;
      const userId = authData.user.id;

      const { data: perfilData, error: perfilError } = await supabaseClient
        .from("profiles")
        .select("rol")
        .eq("id", userId)
        .single();

      if (perfilError || !perfilData) {
        showMessage("Error obteniendo perfil de usuario.", 'error');
        throw new Error("Error perfil");
      }

      rolUsuario = perfilData.rol;
      return rolUsuario;
    } catch (e) {
      console.error('Error obteniendo rol:', e);
      return null;
    }
  }

  // Actualizar precios de pools (guardado en memoria durante la sesi√≥n)
  async function updatePoolPrice(nivel) {
    try {
      const rol = await obtenerRolUsuario();
      if (rol !== "admi") {
        showMessage("No tienes permisos para cambiar precios.", 'error');
        return;
      }
    } catch (error) {
      showMessage("Error verificando permisos.", 'error');
      return;
    }

    const inputMap = {
      'basico': 'priceBasico',
      'medio': 'priceMedio',
      'avanzado': 'priceAvanzado'
    };

    const currentSpanMap = {
      'basico': 'currentPriceBasico',
      'medio': 'currentPriceMedio',
      'avanzado': 'currentPriceAvanzado'
    };

    const inputId = inputMap[nivel];
    const spanId = currentSpanMap[nivel];
    const newPrice = parseInt(document.getElementById(inputId).value);

    if (!newPrice || newPrice <= 0) {
      showMessage("Ingresa un precio v√°lido mayor a 0.", 'error');
      return;
    }

    if (!confirm(`¬øConfirmar cambio de precio del ${poolConfig[nivel].name} a ${formatCurrency(newPrice)}?`)) {
      return;
    }

    try {
      // Actualizar configuraci√≥n en memoria (persiste durante la sesi√≥n)
      poolConfig[nivel].amount = newPrice;
      
      // Actualizar interfaz
      document.getElementById(spanId).textContent = formatCurrency(newPrice);
      
      showMessage(`‚úÖ Precio del ${poolConfig[nivel].name} actualizado a ${formatCurrency(newPrice)}`);
      
      console.log('‚úÖ Nueva configuraci√≥n de precios:', poolConfig);
      
    } catch (error) {
      console.error('Error actualizando precio:', error);
      showMessage('Error actualizando precio: ' + error.message, 'error');
    }
  }

  // Actualizar interfaz de precios
  function updatePriceInterface() {
    Object.keys(poolConfig).forEach(nivel => {
      const inputMap = {
        'basico': 'priceBasico',
        'medio': 'priceMedio',
        'avanzado': 'priceAvanzado'
      };

      const currentSpanMap = {
        'basico': 'currentPriceBasico',
        'medio': 'currentPriceMedio',
        'avanzado': 'currentPriceAvanzado'
      };

      const inputId = inputMap[nivel];
      const spanId = currentSpanMap[nivel];
      
      if (document.getElementById(inputId)) {
        document.getElementById(inputId).value = poolConfig[nivel].amount;
      }
      
      if (document.getElementById(spanId)) {
        document.getElementById(spanId).textContent = formatCurrency(poolConfig[nivel].amount);
      }
    });
  }

  // Cargar solicitudes desde mini_pool
  async function loadRequests() {
    try {
      document.getElementById('loadingMessage').style.display = 'block';
      document.getElementById('requestsTable').style.display = 'none';

      const { data, error } = await supabaseClient
        .from('mini_pool')
        .select('*')
        .order('fecha_entrada', { ascending: false });

      if (error) {
        throw error;
      }

      allRequests = data || [];
      renderRequestsTable();
      updateStatistics();
      updatePendingAlert();
      
      document.getElementById('loadingMessage').style.display = 'none';
      document.getElementById('requestsTable').style.display = 'table';

    } catch (error) {
      console.error('Error cargando solicitudes:', error);
      showMessage('Error cargando datos: ' + error.message, 'error');
      document.getElementById('loadingMessage').style.display = 'none';
    }
  }

  // Renderizar tabla de solicitudes
  function renderRequestsTable() {
    const tbody = document.getElementById('requestsTableBody');
    tbody.innerHTML = '';

    if (allRequests.length === 0) {
      tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No hay solicitudes registradas</td></tr>';
      return;
    }

    allRequests.forEach(request => {
      const row = createRequestRow(request);
      tbody.appendChild(row);
    });
  }

  function createRequestRow(request) {
    const row = document.createElement('tr');
    const expirationDate = addDaysToDate(new Date(request.fecha_entrada), 7);
    const poolInfo = poolConfig[request.nivel] || { name: request.nivel, icon: 'üèä‚Äç‚ôÇÔ∏è' };
    
    row.setAttribute('data-user-id', request.usuario_id || '');
    row.setAttribute('data-email', request.email || '');
    row.setAttribute('data-status', request.estado_pago || '');
    row.setAttribute('data-level', request.nivel || '');

    // Determinar el estado visual
    let statusClass = 'status-pending';
    let statusText = '‚è≥ Pendiente';
    let actionButtons = '';
    
    if (request.estado_pago === 'pagado') {
      statusClass = 'status-pagado';
      statusText = '‚úÖ Pagado';
      actionButtons = `<button class="btn-secondary" onclick="viewRequestDetails('${request.id}')">üëÅÔ∏è Ver</button>`;
    } else if (request.estado_pago === 'rechazado') {
      statusClass = 'status-rejected';
      statusText = '‚ùå Rechazado';
      actionButtons = `
        <button class="btn-approve" onclick="approveRequest('${request.id}')">‚úÖ Aprobar</button>
        <button class="btn-secondary" onclick="viewRequestDetails('${request.id}')">üëÅÔ∏è Ver</button>
      `;
    } else {
      // Estado pendiente
      actionButtons = `
        <button class="btn-approve" onclick="approveRequest('${request.id}')">‚úÖ Aprobar</button>
        <button class="btn-reject" onclick="rejectRequest('${request.id}')">‚ùå Rechazar</button>
        <button class="btn-secondary" onclick="viewRequestDetails('${request.id}')">üëÅÔ∏è Ver</button>
      `;
    }

    row.innerHTML = `
      <td>${request.id}</td>
      <td>${request.usuario_id || 'N/A'}</td>
      <td>${request.email || 'N/A'}</td>
      <td>${poolInfo.icon} ${poolInfo.name}</td>
      <td>${formatCurrency(request.monto)}</td>
      <td>${formatDate(request.fecha_entrada)}</td>
      <td>${formatDate(expirationDate)}</td>
      <td>
        <span class="status ${statusClass}">${statusText}</span>
      </td>
      <td>
        <div class="action-buttons">
          ${actionButtons}
        </div>
      </td>
    `;
    
    return row;
  }

  // Actualizar alerta de solicitudes pendientes
  function updatePendingAlert() {
    const pendingRequests = allRequests.filter(req => req.estado_pago === 'pendiente' || req.estado_pago === null);
    const alertDiv = document.getElementById('pendingAlert');
    const countSpan = document.getElementById('pendingCount');
    
    if (pendingRequests.length > 0) {
      countSpan.textContent = pendingRequests.length;
      alertDiv.style.display = 'block';
    } else {
      alertDiv.style.display = 'none';
    }
  }

  // Actualizar estad√≠sticas
  function updateStatistics() {
    const weekRange = getWeekRange(currentWeekOffset);
    const weekStart = weekRange.start.toISOString();
    const weekEnd = new Date(weekRange.end);
    weekEnd.setHours(23, 59, 59, 999);
    const weekEndStr = weekEnd.toISOString();

    const weekRequests = allRequests.filter(req => {
      const reqDate = new Date(req.fecha_entrada);
      return reqDate >= new Date(weekStart) && reqDate <= new Date(weekEndStr);
    });

    const totalParticipants = weekRequests.length;
    const totalInvested = weekRequests.reduce((sum, req) => sum + Number(req.monto), 0);
    const pendingAmount = weekRequests
      .filter(req => req.estado_pago === 'pendiente' || req.estado_pago === null)
      .reduce((sum, req) => sum + Number(req.monto), 0);
    const paidAmount = weekRequests
      .filter(req => req.estado_pago === 'pagado')
      .reduce((sum, req) => sum + (Number(req.monto) * 2), 0); // Monto duplicado pagado

    document.getElementById('currentWeek').textContent = `Semana del ${weekRange.formatted}`;
    document.getElementById('totalParticipants').textContent = totalParticipants;
    document.getElementById('totalInvested').textContent = formatCurrency(totalInvested);
    document.getElementById('pendingPayments').textContent = formatCurrency(pendingAmount);
    document.getElementById('weekProfit').textContent = formatCurrency(paidAmount);
  }

  // Navegaci√≥n de semanas
  function changeWeek(direction) {
    currentWeekOffset += direction;
    updateStatistics();
  }

  // Filtrar solicitudes
  function filterParticipants() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const levelFilter = document.getElementById('levelFilter').value;
    
    const rows = document.querySelectorAll('#requestsTableBody tr');
    
    rows.forEach(row => {
      const userId = row.getAttribute('data-user-id') || '';
      const email = row.getAttribute('data-email') || '';
      const status = row.getAttribute('data-status') || '';
      const level = row.getAttribute('data-level') || '';

      const matchesSearch = userId.toLowerCase().includes(searchTerm) || 
                          email.toLowerCase().includes(searchTerm);
      const matchesStatus = !statusFilter || status === statusFilter;
      const matchesLevel = !levelFilter || level === levelFilter;

      if (matchesSearch && matchesStatus && matchesLevel) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  }

// Aprobar solicitud de minipool
  async function approveRequest(requestId) {
    try {
      const rol = await obtenerRolUsuario();
      if (rol !== "admi") {
        showMessage("No tienes permisos para aprobar solicitudes.", 'error');
        return;
      }
    } catch (error) {
      showMessage("Error verificando permisos.", 'error');
      return;
    }

    const request = allRequests.find(req => req.id === requestId);
    if (!request) {
      showMessage('Solicitud no encontrada', 'error');
      return;
    }

    const montoAPagar = request.monto * 2; // Duplicar la inversi√≥n
    
    if (!confirm(`¬øAprobar solicitud de ${request.email}?\n\nNivel: ${request.nivel}\nMonto original: ${formatCurrency(request.monto)}\nMonto a pagar: ${formatCurrency(montoAPagar)}`)) {
      return;
    }

    try {
      // 1. Actualizar estado en mini_pool
      const { error: updateError } = await supabaseClient
        .from('mini_pool')
        .update({ 
          estado_pago: 'pagado',
          fecha_pago: new Date().toISOString()
        })
        .eq('id', requestId);

      if (updateError) throw updateError;

      // 2. Actualizar/crear balance del usuario
      const { data: currentBalance, error: balanceError } = await supabaseClient
        .from('balances')
        .select('saldo')
        .eq('usuario_id', request.usuario_id)
        .maybeSingle();

      if (balanceError && balanceError.code !== 'PGRST116') {
        throw balanceError;
      }

      const newBalance = (currentBalance?.saldo || 0) + montoAPagar;

      const { error: balanceUpdateError } = await supabaseClient
        .from('balances')
        .upsert({ 
          usuario_id: request.usuario_id,
          saldo: newBalance
        });

      if (balanceUpdateError) throw balanceUpdateError;

      // 3. Registrar en recompensas para historial
      const { error: recompensaError } = await supabaseClient
        .from('recompensas')
        .insert({
          usuario_id: request.usuario_id,
          meta: null,
          fecha: new Date().toISOString(),
          monto: montoAPagar,
          moneda: 'ARS',
          aprobado: true,
          tipo: `minipool_${request.nivel}`
        });

      if (recompensaError) {
        console.warn('Error registrando en recompensas (no cr√≠tico):', recompensaError);
      }

      showMessage(`‚úÖ Solicitud aprobada exitosamente.\n${request.email} recibi√≥ ${formatCurrency(montoAPagar)} en su balance.`);
      await refreshData();

    } catch (error) {
      console.error('Error aprobando solicitud:', error);
      showMessage('Error aprobando solicitud: ' + error.message, 'error');
    }
  }

  // Rechazar solicitud de minipool
  async function rejectRequest(requestId) {
    try {
      const rol = await obtenerRolUsuario();
      if (rol !== "admi") {
        showMessage("No tienes permisos para rechazar solicitudes.", 'error');
        return;
      }
    } catch (error) {
      showMessage("Error verificando permisos.", 'error');
      return;
    }

    const request = allRequests.find(req => req.id === requestId);
    if (!request) {
      showMessage('Solicitud no encontrada', 'error');
      return;
    }

    if (!confirm(`¬øRechazar solicitud de ${request.email}?\n\nEsta acci√≥n se puede revertir posteriormente.`)) {
      return;
    }

    try {
      const { error } = await supabaseClient
        .from('mini_pool')
        .update({ estado_pago: 'rechazado' })
        .eq('id', requestId);

      if (error) throw error;

      showMessage(`‚ùå Solicitud de ${request.email} rechazada.`);
      await refreshData();

    } catch (error) {
      console.error('Error rechazando solicitud:', error);
      showMessage('Error rechazando solicitud: ' + error.message, 'error');
    }
  }

  // Ver detalles de solicitud
  function viewRequestDetails(requestId) {
    const request = allRequests.find(req => req.id === requestId);
    if (!request) {
      showMessage('Solicitud no encontrada', 'error');
      return;
    }

    const expirationDate = addDaysToDate(new Date(request.fecha_entrada), 7);
    const montoAPagar = request.monto * 2;
    const poolInfo = poolConfig[request.nivel] || { name: request.nivel, icon: 'üèä‚Äç‚ôÇÔ∏è' };
    
    alert(`üìã Detalles de la Solicitud
    
ID: ${request.id}
Usuario ID: ${request.usuario_id}
Email: ${request.email || 'N/A'}
Nivel: ${poolInfo.icon} ${poolInfo.name}
Monto Invertido: ${formatCurrency(request.monto)}
Monto a Pagar: ${formatCurrency(montoAPagar)}
Fecha Entrada: ${formatDate(request.fecha_entrada)}
Fecha Vencimiento: ${formatDate(expirationDate)}
Estado: ${request.estado_pago || 'pendiente'}
${request.fecha_pago ? `Fecha Pago: ${formatDate(request.fecha_pago)}` : ''}`);
  }

  // Procesar todas las solicitudes pendientes
  async function processAllPendingRequests() {
    try {
      const rol = await obtenerRolUsuario();
      if (rol !== "admi") {
        showMessage("No tienes permisos para procesar solicitudes masivas.", 'error');
        return;
      }
    } catch (error) {
      showMessage("Error verificando permisos.", 'error');
      return;
    }

    const pendingRequests = allRequests.filter(req => req.estado_pago === 'pendiente' || req.estado_pago === null);

    if (pendingRequests.length === 0) {
      showMessage('No hay solicitudes pendientes para procesar');
      return;
    }

    const totalAmount = pendingRequests.reduce((sum, req) => sum + (req.monto * 2), 0);

    if (!confirm(`¬øAprobar TODAS las solicitudes pendientes?\n\nTotal: ${pendingRequests.length} solicitudes\nMonto total a pagar: ${formatCurrency(totalAmount)}`)) {
      return;
    }

    try {
      let processed = 0;
      let errors = 0;

      for (const request of pendingRequests) {
        try {
          const montoAPagar = request.monto * 2;

          // Actualizar estado en mini_pool
          const { error: updateError } = await supabaseClient
            .from('mini_pool')
            .update({ 
              estado_pago: 'pagado',
              fecha_pago: new Date().toISOString()
            })
            .eq('id', request.id);

          if (updateError) throw updateError;

          // Actualizar balance del usuario
          const { data: currentBalance } = await supabaseClient
            .from('balances')
            .select('saldo')
            .eq('usuario_id', request.usuario_id)
            .maybeSingle();

          const newBalance = (currentBalance?.saldo || 0) + montoAPagar;

          const { error: balanceError } = await supabaseClient
            .from('balances')
            .upsert({ 
              usuario_id: request.usuario_id,
              saldo: newBalance
            });

          if (balanceError) throw balanceError;

          // Registrar en recompensas para historial (opcional)
          await supabaseClient
            .from('recompensas')
            .insert({
              usuario_id: request.usuario_id,
              meta: null,
              fecha: new Date().toISOString(),
              monto: montoAPagar,
              moneda: 'ARS',
              aprobado: true,
              tipo: `minipool_${request.nivel}`
            });

          processed++;
        } catch (error) {
          console.error(`Error procesando solicitud ${request.id}:`, error);
          errors++;
        }
      }

      showMessage(`‚úÖ Procesamiento completado:\n- Aprobadas: ${processed}\n- Errores: ${errors}\n\nTotal pagado: ${formatCurrency(totalAmount)}`);
      await refreshData();

    } catch (error) {
      console.error('Error en procesamiento masivo:', error);
      showMessage('Error en procesamiento masivo: ' + error.message, 'error');
    }
  }

  // Cargar historial de pagos procesados
  async function loadHistory() {
    try {
      const { data, error } = await supabaseClient
        .from('mini_pool')
        .select('*')
        .eq('estado_pago', 'pagado')
        .order('fecha_pago', { ascending: false })
        .limit(100);

      if (error) throw error;

      const tbody = document.getElementById('historyTableBody');
      tbody.innerHTML = '';

      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No hay pagos procesados</td></tr>';
        return;
      }

      data.forEach(item => {
        const row = document.createElement('tr');
        const poolInfo = poolConfig[item.nivel] || { name: item.nivel, icon: 'üèä‚Äç‚ôÇÔ∏è' };
        const montoOriginal = item.monto;
        const montoPagado = item.monto * 2;
        
        row.innerHTML = `
          <td>${item.usuario_id || 'N/A'}</td>
          <td>${item.email || 'N/A'}</td>
          <td>${poolInfo.icon} ${poolInfo.name}</td>
          <td>${formatCurrency(montoOriginal)}</td>
          <td>${formatCurrency(montoPagado)}</td>
          <td>${item.fecha_pago ? formatDate(item.fecha_pago) : 'N/A'}</td>
          <td>
            <span class="status status-pagado">‚úÖ Pagado</span>
          </td>
        `;
        tbody.appendChild(row);
      });

    } catch (error) {
      console.error('Error cargando historial:', error);
      const tbody = document.getElementById('historyTableBody');
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #f85149;">Error cargando historial</td></tr>';
    }
  }

  // Refrescar todos los datos
  async function refreshData() {
    try {
      await Promise.all([
        loadRequests(),
        loadHistory()
      ]);
      updatePriceInterface();
      showMessage('Datos actualizados correctamente');
    } catch (error) {
      console.error('Error refrescando datos:', error);
      showMessage('Error actualizando datos: ' + error.message, 'error');
    }
  }

  // Inicializar aplicaci√≥n
  async function initializeApp() {
    try {
      console.log('üèä‚Äç‚ôÇÔ∏è Iniciando Panel de Minipools Admin...');
      
      // Verificar autenticaci√≥n y permisos
      const rol = await obtenerRolUsuario();
      if (!rol) {
        showMessage('Error de autenticaci√≥n. Por favor inicia sesi√≥n nuevamente.', 'error');
        // Redirigir despu√©s de un momento
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 3000);
        return;
      }

      if (rol !== 'admi') {
        showMessage('No tienes permisos de administrador para acceder a este panel.', 'error');
        return;
      }

      console.log('‚úÖ Usuario autenticado como admin:', currentUser.email);

      // Inicializar interfaz de precios
      updatePriceInterface();

      // Cargar datos iniciales
      await refreshData();
      
      console.log('üìä Panel de Minipools Admin cargado correctamente');
      console.log('üí∞ Configuraci√≥n de precios:', poolConfig);
      
    } catch (error) {
      console.error('Error inicializando aplicaci√≥n:', error);
      showMessage('Error inicializando el sistema: ' + error.message, 'error');
    }
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', initializeApp);

  // Suscripci√≥n a cambios en tiempo real para mini_pool
  const realtimeSubscription = supabaseClient
    .channel('minipool_changes')
    .on('postgres_changes', 
      { 
        event: '*', 
        schema: 'public', 
        table: 'mini_pool'
      }, 
      (payload) => {
        console.log('üì° Cambio detectado en mini_pool:', payload);
        // Recargar datos despu√©s de un cambio
        setTimeout(() => refreshData(), 1000);
      }
    )
    .subscribe();

  // Funciones globales para acceso desde HTML
  window.changeWeek = changeWeek;
  window.filterParticipants = filterParticipants;
  window.approveRequest = approveRequest;
  window.rejectRequest = rejectRequest;
  window.viewRequestDetails = viewRequestDetails;
  window.processAllPendingRequests = processAllPendingRequests;
  window.refreshData = refreshData;
  window.updatePoolPrice = updatePoolPrice;

  console.log('üéØ Sistema de Minipools Admin - Listo para usar');
  console.log('üìã Funciones disponibles: aprobar, rechazar, procesar masivamente');
  console.log('üí∞ Sistema de balances integrado');

</script>
</body>
</html>
