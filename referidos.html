<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Referidos - Admi</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    body {
      background-color: #111;
      color: white;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h2 {
      color: #00d4ff;
    }
    input[type="text"] {
      padding: 10px;
      margin-bottom: 15px;
      width: 100%;
      max-width: 400px;
      border-radius: 4px;
      border: none;
      font-size: 16px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: #fff;
      color: #000;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #ccc;
      text-align: left;
    }
    th {
      background-color: #00a8ff;
      color: white;
    }
    button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }
    button.aprobar {
      background-color: #2ecc71;
      color: white;
    }
    button.rechazar {
      background-color: #e74c3c;
      color: white;
    }
    .estado {
      text-transform: capitalize;
      font-weight: bold;
    }

    /* Estilo para la sección admin recompensas */
    #admin-recompensas {
      padding: 20px;
      background-color: rgba(255,255,255,0.9);
      border-radius: 10px;
      margin-top: 20px;
      color: black;
    }
    #admin-recompensas h2 {
      color: #0077cc;
      text-align: center;
      margin-bottom: 20px;
    }
    #admin-recompensas table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: #fff;
      color: #000;
      border-radius: 8px;
      overflow: hidden;
    }
    #admin-recompensas th, #admin-recompensas td {
      padding: 12px;
      border-bottom: 1px solid #ccc;
      text-align: center;
    }
    #admin-recompensas th {
      background-color: #00a8ff;
      color: white;
    }
    #admin-recompensas button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
      background-color: #2ecc71;
      color: white;
    }

    .progress-container {
      margin-bottom: 15px;
      padding: 10px;
      background: #222;
      border-radius: 8px;
    }
    
    .progress-bar {
      background: #555;
      border-radius: 6px;
      overflow: hidden;
      height: 20px;
      margin: 5px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #00d4ff, #0099cc);
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <h2>Lista de Referidos</h2>
  
  <div id="progresoReferidos" style="background: #222; color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
    <h3>Progreso Visual por Usuario</h3>
    <div id="barrasProgreso"></div>
  </div>
  
  <input type="text" id="buscador" placeholder="Buscar por correo, ID o referido por..." oninput="filtrarReferidos()" />
  <table>
    <thead>
      <tr>
        <th>Correo del referido</th>
        <th>Referido por (ID)</th>
        <th>Fecha</th>
        <th>Aprobado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tablaReferidos"></tbody>
  </table>

  <!-- SECCIÓN ADMIN - GESTIÓN DE RECOMPENSAS POR REFERIDOS -->
  <section id="admin-recompensas">
    <h2>Gestión de Recompensas por Referidos</h2>
    <div style="margin-bottom: 15px; padding: 10px; background: #f0f8ff; border-radius: 5px;">
      <strong>Sistema de Metas Acumulativas:</strong><br>
      • 5 referidos = $20.000 ARS<br>
      • 15 referidos (5+10) = $80.000 ARS adicionales<br>
      • 35 referidos (5+10+20) = $100.000 ARS adicionales<br>
      • 85 referidos (5+10+20+50) = $250.000 ARS adicionales
    </div>
    <table id="tabla-recompensas" border="1">
      <thead>
        <tr>
          <th>Email del Usuario</th>
          <th>Referidos Confirmados</th>
          <th>Próxima Meta</th>
          <th>Recompensas Pagadas</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody id="cuerpo-recompensas">
        <!-- Se insertarán las filas dinámicamente con JS -->
      </tbody>
    </table>
  </section>

<script>
    const { createClient } = supabase;
    const supabaseClient = createClient(
      'https://ovulezkcxwrjvyxlxsdv.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92dWxlemtjeHdyanZ5eGx4c2R2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNzY5OTksImV4cCI6MjA2NDY1Mjk5OX0.ac82tkUR7AT0QVsuzuAGA8SXLkgnM9OX62meYNGnToI'
    );

    let referidosData = [];

    // Definir las metas acumulativas
    const METAS_ACUMULATIVAS = [
      { total_requerido: 5, recompensa: 20000, nombre: "5 referidos" },
      { total_requerido: 15, recompensa: 80000, nombre: "15 referidos (5+10)" },
      { total_requerido: 35, recompensa: 100000, nombre: "35 referidos (5+10+20)" },
      { total_requerido: 85, recompensa: 250000, nombre: "85 referidos (5+10+20+50)" }
    ];

    async function cargarReferidos() {
      const { data, error } = await supabaseClient
        .from('referidos')
        .select('*')
        .order('fecha', { ascending: false });

      if (error) {
        console.error(error);
        alert('Error al cargar referidos');
        return;
      }

      referidosData = data;
      mostrarReferidos(referidosData);
      await mostrarProgresoVisual();
    }

    function mostrarReferidos(data) {
      const tabla = document.getElementById('tablaReferidos');
      tabla.innerHTML = '';

      if (!data || data.length === 0) {
        tabla.innerHTML = '<tr><td colspan="5">No se encontraron referidos.</td></tr>';
        return;
      }

      data.forEach(ref => {
        const fila = document.createElement('tr');
        fila.innerHTML = `
          <td>${ref.email}</td>
          <td>${ref.referido_por}</td>
          <td>${new Date(ref.fecha).toLocaleString()}</td>
          <td class="estado">${ref.aprobado ? 'Sí' : 'No'}</td>
          <td>
            <button class="aprobar" onclick="aprobarReferido('${ref.id}', '${ref.referido_por}')">Aprobar</button>
            <button class="rechazar" onclick="rechazarReferido('${ref.id}')">Rechazar</button>
          </td>
        `;
        tabla.appendChild(fila);
      });
    }

    function filtrarReferidos() {
      const query = document.getElementById('buscador').value.toLowerCase();

      const filtrados = referidosData.filter(ref => {
        const email = (ref.email || '').toLowerCase();
        const referidoPor = (ref.referido_por || '').toLowerCase();
        const id = (ref.id || '').toLowerCase();

        return email.includes(query) || referidoPor.includes(query) || id.includes(query);
      });

      mostrarReferidos(filtrados);
    }
async function aprobarReferido(id, referidoPor) {
      const { error: errorAprobar } = await supabaseClient
        .from('referidos')
        .update({ aprobado: true })
        .eq('id', id);

      if (errorAprobar) return alert('Error al aprobar referido');

      // Contar referidos aprobados
      const { data: aprobados, error: errorContar } = await supabaseClient
        .from('referidos')
        .select('*')
        .eq('referido_por', referidoPor)
        .eq('aprobado', true);

      if (errorContar || !aprobados) return alert('Error al contar referidos');
      
      const totalReferidos = aprobados.length;
      console.log(`Usuario ${referidoPor} tiene ${totalReferidos} referidos confirmados`);

      // Verificar qué metas puede alcanzar
      for (const meta of METAS_ACUMULATIVAS) {
        if (totalReferidos >= meta.total_requerido) {
          // Verificar si ya se pagó esta meta
          const { data: yaExiste, error: errYaExiste } = await supabaseClient
            .from('recompensas')
            .select('*')
            .eq('usuario_id', referidoPor)
            .eq('meta', meta.total_requerido)
            .maybeSingle();

          if (errYaExiste) continue;

          if (!yaExiste) {
            // Insertar nueva recompensa
            const { error: errorRecompensa } = await supabaseClient
              .from('recompensas')
              .insert({
                usuario_id: referidoPor,
                meta: meta.total_requerido,
                recompensa_ars: meta.recompensa,
                fecha: new Date().toISOString(),
                aprobado: false
              });

            if (errorRecompensa) {
              console.error('Error al insertar recompensa:', errorRecompensa);
              continue;
            }

            alert(`¡Meta alcanzada! ${meta.nombre}. Recompensa de $${meta.recompensa} ARS disponible para aprobación.`);
          }
        }
      }

      cargarReferidos();
      cargarRecompensasReferidos();
    }

    async function rechazarReferido(id) {
      const { error } = await supabaseClient
        .from('referidos')
        .delete()
        .eq('id', id);

      if (error) return alert('Error al eliminar referido');
      cargarReferidos();
      cargarRecompensasReferidos();
    }

    async function mostrarProgresoVisual() {
      const contenedor = document.getElementById("barrasProgreso");
      contenedor.innerHTML = "";

      const { data: perfiles, error: errorPerfiles } = await supabaseClient
        .from("profiles")
        .select("id, email");

      if (errorPerfiles) {
        console.error("Error al obtener perfiles:", errorPerfiles.message);
        return;
      }

      for (const perfil of perfiles) {
        const { data: referidos, error } = await supabaseClient
          .from("referidos")
          .select("id")
          .eq("referido_por", perfil.id)
          .eq("aprobado", true);

        if (error) continue;

        const cantidad = referidos.length;
        
        // Encontrar la próxima meta
        const proximaMeta = METAS_ACUMULATIVAS.find(m => m.total_requerido > cantidad);
        const metaAnterior = METAS_ACUMULATIVAS.slice().reverse().find(m => m.total_requerido <= cantidad);
        
        let progreso = 0;
        let textoProgreso = "";
        
        if (proximaMeta) {
          const base = metaAnterior ? metaAnterior.total_requerido : 0;
          progreso = ((cantidad - base) / (proximaMeta.total_requerido - base)) * 100;
          textoProgreso = `${cantidad}/${proximaMeta.total_requerido} - Próxima: ${proximaMeta.nombre}`;
        } else {
          progreso = 100;
          textoProgreso = `${cantidad}/✓ - ¡Todas las metas completadas!`;
        }

        const barra = document.createElement("div");
        barra.className = "progress-container";

        barra.innerHTML = `
          <div><strong>${perfil.email}</strong> - ${cantidad} referidos confirmados</div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${Math.max(progreso, 5)}%;"></div>
          </div>
          <small>${textoProgreso}</small>
        `;

        contenedor.appendChild(barra);
      }
    }

    async function cargarRecompensasReferidos() {
      const { data: perfiles, error: errorPerfiles } = await supabaseClient
        .from('profiles')
        .select('id, email');

      if (errorPerfiles) {
        console.error('Error al cargar perfiles:', errorPerfiles.message);
        return;
      }

      const cuerpo = document.getElementById('cuerpo-recompensas');
      cuerpo.innerHTML = '';

      for (const perfil of perfiles) {
        // Contar referidos confirmados
        const { data: referidos, error: errorReferidos } = await supabaseClient
          .from('referidos')
          .select('id')
          .eq('referido_por', perfil.id)
          .eq('aprobado', true);

        if (errorReferidos) continue;

        const cantidadReferidos = referidos.length;

        // Obtener recompensas ya pagadas
        const { data: recompensasPagadas, error: errorRecompensas } = await supabaseClient
          .from('recompensas')
          .select('*')
          .eq('usuario_id', perfil.id)
          .eq('aprobado', true);

        if (errorRecompensas) continue;

        // Obtener recompensas pendientes
        const { data: recompensasPendientes, error: errorPendientes } = await supabaseClient
          .from('recompensas')
          .select('*')
          .eq('usuario_id', perfil.id)
          .eq('aprobado', false);

        if (errorPendientes) continue;

        // Determinar próxima meta
        const proximaMeta = METAS_ACUMULATIVAS.find(m => m.total_requerido > cantidadReferidos);
        const textoProximaMeta = proximaMeta ? 
          `${cantidadReferidos}/${proximaMeta.total_requerido} - ${proximaMeta.nombre}` : 
          "¡Todas completadas!";

        // Crear lista de recompensas pagadas
        const recompensasPagadasTexto = recompensasPagadas.length > 0 ?
          recompensasPagadas.map(r => `${r.meta} ref: $${r.recompensa_ars}`).join('<br>') :
          'Ninguna';

        // Botones para recompensas pendientes
        const botonesPendientes = recompensasPendientes.map(r => 
          `<button onclick="aprobarRecompensa('${perfil.id}', ${r.meta}, ${r.recompensa_ars})" style="margin: 2px; font-size: 12px;">
            Pagar ${r.meta} ref ($${r.recompensa_ars})
           </button>`
        ).join('');

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${perfil.email}</td>
          <td style="text-align:center;">${cantidadReferidos}</td>
          <td style="text-align:center;">${textoProximaMeta}</td>
          <td style="text-align:center; font-size: 12px;">${recompensasPagadasTexto}</td>
          <td style="text-align:center;">${botonesPendientes}</td>
        `;
        cuerpo.appendChild(tr);
      }
    }

    async function aprobarRecompensa(userId, meta, recompensa) {
      // Actualizar la recompensa como aprobada
      const { error: errorAprobar } = await supabaseClient
        .from('recompensas')
        .update({ aprobado: true })
        .eq('usuario_id', userId)
        .eq('meta', meta);

      if (errorAprobar) {
        alert('Error al aprobar recompensa');
        console.error(errorAprobar);
        return;
      }

      // Actualizar balance del usuario
      const { data: balance, error: errorBalance } = await supabaseClient
        .from('balances')
        .select('saldo')
        .eq('usuario_id', userId)
        .maybeSingle();

      if (errorBalance) {
        console.error('Error al obtener balance:', errorBalance);
      } else {
        const nuevoSaldo = (balance?.saldo || 0) + recompensa;
        
        if (balance) {
          await supabaseClient
            .from('balances')
            .update({ saldo: nuevoSaldo })
            .eq('usuario_id', userId);
        } else {
          await supabaseClient
            .from('balances')
            .insert({ usuario_id: userId, saldo: recompensa });
        }
      }

      alert(`Recompensa aprobada: $${recompensa} ARS por ${meta} referidos`);
      cargarRecompensasReferidos();
    }

    // Inicializar cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', function() {
      cargarReferidos();
      cargarRecompensasReferidos();
    });
</script>

</body>
</html>
